# Package Introduction

## Input
This package gets infromation about the relative positions between mbx, fwx and uav.

## Output
This package outputs the goal of joint values under a set of relative positions.

# 目前工作
- [ ] 构造一个代价函数，在给定一个三角形的情况下，把它分布在每个机器人特定的区域内。

# 优化框架

## 提前注明

为了接下来的表意方便，对符号作出如下约定

* $SE3$是齐次变换矩阵，为一个$4\times 4$矩阵，属于$SE(3)$空间中
* $SO3$是旋转矩阵，为一个$3\times 3$矩阵，属于$SO(3)$空间中

## 场地条件

我认为，这个场地是长10m，宽6m，高3m的长方体，因此在进行规划之前，首先要对轨迹和场地墙壁进行碰撞检测，保证轨迹和场地墙壁不会发生碰撞。

## 给定位置

存在一系列的离散时刻，可以称之为$t_0, t_1, \dots, t_n$这样$n$个时刻，这任意一个时刻$t_i,(1<i<n)$都有mbx, fwx和uav的相对位置，如果我们以**mbx为三者之间的原点**，那么三者之间的$SE3$如下

* mbx：

  * $$
    T_{mi}=\left[
     \begin{matrix}
       I_{3\times 3} & 0_{3\times 1} \\
       0_{1\times 3} & 1
      \end{matrix} 
    \right]
    =I_{4\times 4}
    $$
  
* fwx：

  * $$
    T_{fi}=\left[
     \begin{matrix}
       R_{fi\ 3\times 3} & P_{fi\ 3\times 1} \\
       0_{1\times 3} & 1
      \end{matrix} 
    \right]
    $$

* uav的坐标是

  * $$
    T_{ui}=\left[
     \begin{matrix}
       R_{ui\ 3\times 3} & P_{ui\ 3\times 1} \\
       0_{1\times 3} & 1
      \end{matrix} 
    \right]
    $$

这样就会存在2个向量

* 从mbx指向fwx的向量$P_{fi}=(x_{fi},y_{fi},z_{fi})$
* 从mbx指向uav的向量$P_{ui}=(x_{ui},y_{ui},z_{ui})$

从表面上看，这样会构成一个三角形。那么，我们的目标是在给定这样的相对位置之后，求出他们三个在空间中的绝对位置，也即：
* 输入是$T_{mi},T_{fi},T_{ui}$
* 输出是三者的绝对位姿$(S_{mi}, Q_{mi}), (S_{fi}, Q_{fi}), (S_{ui}, Q_{ui})$

## 计算步骤
1. 首先规定一个长方体，比如说就是整个房间的$\frac{1}{4}\sim \frac{3}{4}$高度，然后长宽也都是$\frac{1}{4}\sim \frac{3}{4}$，这样构成的一个长方体。我们的目标是将给定的三角形分布在这个长方体里面，并且尽量保证他们离边界比较远。
2. 目前想到的一种比较好的方法是基于增量的方法。
3. 在初始化的时候，给定$T_{f0}, T_{u0}$，我们可以近乎随意的将它分配在上述正方体之中。这个时候一个可能需要考虑的问题就是mbx的位姿应当尽量靠近竖直平面，并且在竖直平面内成45度。这么做的原因是要考虑到并联机构的运动范围，因为并联机构的初始位置是在$45^\circ$。另一个需要考虑的因素是fwx的工作臂所在的位置，因为这关系到iiwa机器人的可操作度$\omega=\sqrt{\det(J^TJ)}$。不过在初始情况下，这并不好确定。因为初始情况下，并不存在上一时刻的绝对位姿状态作为参考，并且系统的冗余度比较高，所以我建议首先关注并联机构的位置，将它调整到某一个可以接受的范围内，比如$30^\circ \sim 60^\circ$这个范围内，动平台在默认高度的$0.5\sim 1.5$倍范围内就行吧。
4. 在初始化之后，给定的每一个状态都有其前面的一个状态。也即，对于时刻$t_i$来说，都有一个之前的时刻$t_{i-1}$。
5. 所谓的增量式方法，就是认为$t_{i-1}$时刻的位姿是一种比较优的位姿，我在计算$t_i$时刻的位姿的时候，就从$t_{i-1}$时刻的位姿出发进行采样式的优化。
6. 在给定相对位姿$T_{fi},T_{ui}$之后，再确定mbx的绝对位姿，这三个对象的绝对位姿就全部确定了。因此，优化的自变量有6个，也即mbx的绝对位姿$S_{mi}=(X_{mi},Y_{mi},Z_{mi}),Q_{mi}=(qx_{mi}, qy_{mi}, qz_{mi}, qw_{mi})$。其中，$Q$是四元数。(四元数在运算中依然会被转换成齐次变换矩阵来进行运算)。
7. 既然我们相信在$t_{i-1}$时刻的绝对位姿是一种比较优的位姿，并且$i$时刻给定的相对位姿与$i-1$时刻给定的相对位姿相差并不多，那么，我们也就应该认为$t_i$时刻的位姿应当与$t_{i-1}$时刻的位姿之间联系非常紧密，也即，$t_i$时刻的位姿应当在$t_{i-1}$时刻的位姿上通过某种方法得到。
8. 在这里，我们选择的方法是一种类似于穷举的方法，或者叫采样也可以。假设$t_{i-1}$时刻mbx的位姿是
  $$S_{m(i-1)}=(X_{m(i-1)},Y_{m(i-1)},Z_{m(i-1)}),\\
  Q_{m(i-1)}=(qx_{m(i-1)}, qy_{m(i-1)}, qz_{m(i-1)}, qw_{m(i-1)})
  $$
9. 那么，我们穷举的范围是
$$
|X-X_{m(i-1)}|<\epsilon_x\\
|Y-Y_{m(i-1)}|<\epsilon_y\\
|Z-Z_{m(i-1)}|<\epsilon_z\\
|\alpha-\alpha_{m(i-1)}|<\epsilon_\alpha\\
|\beta-\beta_{m(i-1)}|<\epsilon_\alpha\\
|\gamma-\gamma_{m(i-1)}|<\epsilon_\gamma\\
$$
其中$\alpha$代表roll角，$\beta$代表pitch角，$\gamma$代表yaw角。虽然上面写的是四元数，但是由于只有六个变量，所以在这里就用rpy角来代替了。其实，另一部分原因也是四元数的改变在三维空间中体现的并不很直观，而rpy角的改变则可以直观的被感受到，所以我们在这里采用rpy角来表征mbx绕自身的旋转。这里先粗略的假定
$$
\epsilon_x=\epsilon_y=\epsilon_y=\epsilon_\alpha=\epsilon_\beta=\epsilon_\gamma=0.05
$$

10. 另外一点需要说明的是，这里的rpy角的变换规则是先绕$x$轴旋转$\alpha$，再绕$y$轴旋转$\beta$，最后绕$z$轴旋转$\gamma$。也即从原点到$mbx$的变换为
$$
T_o^{m}(t_i)=Trans_{x,X_{mi}}*Trans_{y,Y_{mi}}*Trans_{z,Z_{mi}}*Rot_{x,\alpha_{mi}}*Rot_{x,\beta_{mi}}*Rot_{z,\gamma_{mi}}
$$

11. 目标函数的选用的有如下几项
    1. 距离项：在上述描述中，我提及了有一个较小的长方体，这里的距离项是指mbx、fwx和uav分别到长方体六个面的距离的平方和的和，用公式叙述如下
    $$
    \sum_{i \in m,f,u}\sum_{j=1}^6 \frac{(A_jx_i+B_jy_i+C_jz_i+D_j)^2}{A_j^2+B_j^2+C_j^2}
    $$
    2. 变化项：由于$t_i$时刻的相对位姿与$t_{i-1}$时刻的相对位姿是不同的，而且我们采用了采样的方法，mbx的xyz和rpy都会发生变化，所以$t_i$时刻的绝对位姿与$t_{i-1}$时刻的相对位姿是有差别的。因此，我们才有了这个变化项。初步就定成xyz和rpy角的变化好了。公式表述如下。
    $$
    \sum_{i \in m,f,u} \Delta_{xi}^2+\Delta_{yi}^2+\Delta_{zi}^2+\Delta_{\alpha i}^2+\Delta_{\beta i}^2+\Delta_{\gamma i}^2
    $$

## 输入约定
1. 输入应当分成三部分
   1. 时间
   2. fwx相对于mbx的位姿
   3. uav相对于mbx的位姿
2. 因此，输入应当有$1+7+7=15$列
   1. 第1列：时间
   2. 第2-8列：fwx相对于mbx的xyz和四元数
   3. 第9-15列：uav相对于mbx的xyz和四元数

## 计算次序
1. 读入数据：`read_relative_poses`，从文件中读数相对位姿，每一个时刻的位姿存储为`(float, Transform, Transform)`的`tuple`，各个时刻的元组依次被存储于一个`list`当中。
2. 分配第一个位姿：`allocate_first_pose`，将第一个相对位姿分配到一个合适的绝对位姿。我觉得这个分配的方法也可以是采样，比如说采样的原点是mbx上`wx_link`的原点，然后以章动的方式进行采样，最大的章动角是$10^\circ$，以$1^\circ$为步长进行采样，对于一个章动角都可以旋转一圈，然后在这一圈上以$10^\circ$为步长进行评估，选出一个比较优的绝对位姿作为初始位姿。
   1. 一个可选的选项是对于分配得到的fwx的位姿进行逆运动学解算，看看能不能达到这个位置
3. 分配下一个位姿：`allocate_next_pose`，基于上一个绝对位姿，利用采样的方法将当前相对位姿分配成绝对位姿
4. 分配其余位姿：`allocate_resting_poses`，顺序调用`allocate_next_pose`，将所有的相对位姿都分配为绝对位姿
5. 分别创建mbx, fwx和uav的frame，这样，在分配得到上述绝对位置之后，就把它们都发送到空间中进行展示

# Deprecated

## 计算步骤

1. 我首先规定一个长方体，比如说就是整个房间的$\frac{1}{4}\sim \frac{3}{4}$高度，然后长宽也都是$\frac{1}{4}\sim \frac{3}{4}$，这样构成的一个长方体。
2. 既然我们获得了mbx, fwx和uav构成的三角形，那么我们不妨让整个三角形的重心位于这个长方体的中心，这样就可以保证他们都位于靠中间的位置，不至于让它们过于靠墙。那么，直觉上，这样会对三个机器人在空间中的部署比较有利。
3. 接下来的一个问题就是，确定了三角形的重心之后，这个三角形还是可以绕着重心进行旋转。因此，我们还需要对这个三角形的每一个角点进行确定。那么我们可以把这个长方体分成三个空间，也就是说按照等角$60^\circ$的方式分成三个空间，分别属于三个机器人。然后，设定一种函数，比如说跟角的两边与地面or上面的距离的平方，优化这个函数，得到三个末端在空间的位置。由于这是一个三角形，所以在将这个三角形分布到空间中的时候，末端绕自身的旋转也就确定了下来。因此，在考虑将三者的运动分配到三个空间中的时候，也可以将末端的运动加到代价函数上来
4. 这样可以计算得到一系列的离散路径点，对于这些得到的路径点，如果两个点之间太过稀疏，可以考虑对时间进行线性插值。
5. 那么，对于三个机械臂中的任意一个来说，任务就变成了机械臂末端的轨迹跟随。
6. 在获得了轨迹的情况下，我们可以以“可操作度”$\omega=\sqrt{\det(J^TJ)}$来描述当前机械臂的操作性能
7. 可以设定一个阈值范围，比如说可操作度$\omega$在区间$[a,b]$之间，操作臂的基底是不会发生运动的，但是如果$\omega<a$，那么就要发生基底的移动，让$\omega$重新回到$[a,b]$的区间之中。

# 具体计算

## 边界

对于上述的长方体，通过计算他的边界分别是
1. $x\in (-2.5, 2.5)$
2. $y\in (-1.5, 1.5)$
3. $x\in (-0.75, 0.75)$

以如下三个面为边界，分别构造出三个区域
1. 边界1：$y=0,0\le x\le 2.5, -0.75\le z\le 0.75$
2. 边界2：$y=-\sqrt{3}x, -\frac{\sqrt{3}}{2}\le x\le 0, -0.75\le z\le 0.75$
3. 边界3：$y=\sqrt{3}, -\frac{\sqrt{3}}{2}\le x\le 0, -0.75\le z\le 0.75$

三个边界如下图所示
![](./pics/bounds.jpg)

其中区域1 $V_1$为mbx末端的运动区域，区域2 $V_2$为fwx的运动区域，区域3 $V_3$为uav的运动区域。

## 运动约束

1. 虽然我们已经将三者分别分配到三个区域之中，存在一定的对边界墙壁进行碰撞的能力，但是，直觉上，三者越靠近原点，其对于墙壁的避免碰撞能力将会有所上升。
   1. 解决：考虑将与墙面的距离的平方直接引入代价函数
   2. 问题：可能存在切变

2. 分成三个区域

# 中期思路

## 运动分配

### 输入

三个机器人的相对位型：

mbx：
$$
  T_{mi}=\left[
  \begin{matrix}
    I_{3\times 3} & 0_{3\times 1} \\
    0_{1\times 3} & 1
  \end{matrix} 
  \right]
  =I_{4\times 4}
$$

fwx:
$$
  T_{fi}=\left[
  \begin{matrix}
    R_{fi\ 3\times 3} & P_{fi\ 3\times 1} \\
    0_{1\times 3} & 1
  \end{matrix} 
  \right]
$$

uav:
$$
  T_{ui}=\left[
  \begin{matrix}
    R_{ui\ 3\times 3} & P_{ui\ 3\times 1} \\
    0_{1\times 3} & 1
  \end{matrix} 
  \right]
$$

在进行位置分配优化的时候，可能会对上述矩阵进行

## 运动规划